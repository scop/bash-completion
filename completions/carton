# carton(3pm) completion                                   -*- shell-script -*-

_comp_cmd_carton__commands()
{
    local cmds=$("${1:-carton}" usage 2>&1 |
        command sed -ne '/.*command.* is one of/{n;p;q;}')
    COMPREPLY+=($(IFS="$IFS," compgen -W "$cmds" -- "$cur"))
}

_comp_cmd_carton__command_help()
{
    local help=$(PERLDOC_PAGER=cat PERLDOC=-otext "${1:-carton}" -h "$2" 2>&1)
    COMPREPLY+=($(compgen -W '$help' -- "$cur"))
}

_comp_cmd_carton()
{
    local cur prev words cword split comp_args
    _comp_initialize -s -- "$@" || return

    local i command="" has_command=""
    for ((i = 1; i < cword; i++)); do
        case ${words[i]} in
            -*) ;;
            *)
                command=${words[i]}
                has_command=set
                break
                ;;
        esac
    done

    if [[ ! $has_command ]]; then
        _comp_cmd_carton__commands "$1"
        return
    fi

    case $prev in
        --version | -v)
            return
            ;;
        --help | -h)
            [[ $has_command ]] || _comp_cmd_carton__commands "$1"
            return
            ;;
        --cpanfile)
            if [[ $command == install ]]; then
                _filedir
                return
            fi
            ;;
        --path)
            if [[ $command == install ]]; then
                _filedir -d
                return
            fi
            ;;
        --without)
            if [[ $command == install ]]; then
                local phases="configure build test runtime develop"
                COMPREPLY+=($(compgen -W '$phases' -- "$cur"))
                return
            fi
            ;;
    esac

    $split && return

    if [[ $cur == -* ]]; then
        [[ $command == @(help|usage) ]] || COMPREPLY=(--help)
        _comp_cmd_carton__command_help "$1" "$command"
    fi

    case $command in
        show | update)
            : # TODO modules completion
            ;;
    esac
} &&
    complete -F _comp_cmd_carton carton

# ex: filetype=sh
